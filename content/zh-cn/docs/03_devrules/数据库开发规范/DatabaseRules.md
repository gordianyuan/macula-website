---
title: "数据库规范"
linkTitle: "数据库规范"
weight: 1
---

## 基础规范
+ 表存储引擎必须使用InnoDB
+ 表字符集默认使用utf8，必要时候使用utf8mb4
  > 通用，无乱码风险，汉字3字节，英文1字节
  > utf8mb4是utf8的超集，有存储4字节例如表情符号时，使用它
+ 禁止使用存储过程，视图，触发器
  > 对数据库性能影响较大，互联网业务，能让站点层和服务层干的事情，不要交到数据库层
  > 调试，排错，迁移都比较困难，扩展性较差
+ 禁止在数据库中存储大文件，例如照片，可以将大文件存储在对象存储系统，数据库中存储路径

## 表设计规范
+ 单实例表个数必须控制在2000个以内
+ 单表分表个数必须控制在1024个以内
+ 表必须有主键，推荐使用UNSIGNED整数为主键
  > 删除无主键的表，如果是row模式的主从架构，从库会挂住
+ 禁止使用外键，如果要保证完整性，由应用程序实现
  > 外键使得表之间相互耦合，影响update/delete等SQL性能，有可能造成死锁，高并发情况下容易成为数据库瓶颈
+ 建议将大字段，访问频度低的字段拆分到单独的表中存储，分离冷热数据

## 列设计规范
+ 根据业务区分使用tinyint/int/bigint，分别会占用1/4/8字节
+ 根据业务区分使用char/varchar
  > 字段长度固定，或者长度近似的业务场景，适合使用char，能够减少碎片，查询性能高
  > 字段长度相差较大，或者更新较少的业务场景，适合使用varchar，能够减少空间
+ 存储年使用year，存储日期使用date，存储时间使用datetime
  > datetime使用DEFAULT CURRENT_TIMESTAMP 和 ON UPDATE CURRENT_TIMESTAMP定义默认值和默认更新
+ 必须把字段定义为NOT NULL并设默认值
  > NULL的列使用索引，索引统计，值都更加复杂，MySQL更难优化
  > NULL需要更多的存储空间
  > NULL只能采用IS NULL或者IS NOT NULL，而在=/!=/in/not in时有大坑
+ 使用varchar(20)存储手机号，不要使用整数
  > 牵扯到国家代号，可能出现+/-/()等字符，例如+86
  > 手机号不会用来做数学运算
  > varchar可以模糊查询，例如like ‘138%’
+ 使用TINYINT来代替ENUM
  > ENUM增加新值要进行DDL操作

## 索引规范
+ 单张表索引数量建议控制在5个以内
  > 互联网高并发业务，太多索引会影响写性能
  > 生成执行计划时，如果索引太多，会降低性能，并可能导致MySQL选择不到最优索引
  > 异常复杂的查询需求，可以选择ES等更为适合的方式存储
+ 组合索引字段数不建议超过5个
  > 如果5个字段还不能极大缩小row范围，八成是设计有问题
+ 不建议在频繁更新的字段上建立索引
+ 非必要不要进行JOIN查询，如果要进行JOIN查询，被JOIN的字段必须类型相同，并建立索引
  > JOIN字段类型不一致，会导致全表扫描
+ 理解组合索引最左前缀原则，避免重复建设索引，
  > 如果建立了(a,b,c)，相当于建立了(a), (a,b), (a,b,c)
